import { useState } from 'react';
import { useParams } from 'wouter';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { useVoiceToText } from '@/hooks/use-voice-to-text';
import { useAuth } from '@/hooks/use-auth';

export default function PatientNotesPage() {
  const { user } = useAuth();
  const { patientId } = useParams();
  const [note, setNote] = useState('');
  const [drafts, setDrafts] = useState([]);
  const { isRecording, transcript, startRecording, stopRecording } = useVoiceToText();

  const handleSaveDraft = async () => {
    const response = await fetch(`/api/patients/${patientId}/notes/drafts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        note,
        providerId: user?.id,
        date: new Date().toISOString(),
        patientId,
        status: 'draft',
      }),
    });
    const newDraft = await response.json();
    setDrafts([...drafts, newDraft]);
    setNote('');
  };

  const handleUseTranscript = () => {
    setNote(transcript);
  };

  return (
    <div className="p-4 space-y-4">
      <h1 className="text-2xl font-bold">Patient Notes</h1>
      <Textarea
        placeholder="Write or dictate your note..."
        value={note}
        onChange={(e) => setNote(e.target.value)}
      />
      <div className="flex gap-2">
        <Button onClick={isRecording ? stopRecording : startRecording}>
          {isRecording ? 'Stop Recording' : 'Start Voice Input'}
        </Button>
        <Button onClick={handleUseTranscript}>Use Transcript</Button>
        <Button onClick={handleSaveDraft}>Save Draft</Button>
      </div>
      <div>
        <h2 className="text-xl font-semibold mt-6">Drafts (Needs Approval)</h2>
        <ul className="mt-2 space-y-2">
          {drafts.map((draft) => (
            <li key={draft.id} className="border rounded p-2 bg-yellow-50">
              <p className="font-semibold">Date: {new Date(draft.date).toLocaleString()}</p>
              <p>{draft.note}</p>
              <p className="text-sm italic">Status: {draft.status}</p>
              {/* Future: Approve/Edit UI goes here */}
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
