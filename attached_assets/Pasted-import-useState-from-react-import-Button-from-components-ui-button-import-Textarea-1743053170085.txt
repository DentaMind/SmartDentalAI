import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import { useEffect } from 'react';

const templates = {
  'Comprehensive Exam': `Subjective: Patient presents for a comprehensive exam. Chief complaint: ____. 
Objective: Medical history reviewed. Vitals recorded. Clinical exam performed. 
Assessment: ____. 
Plan: ____.`,
  'New Patient Intake': `Subjective: New patient visit. Chief concern: ____. 
Objective: Full mouth series taken. Reviewed dental/medical history. 
Assessment: ____. 
Plan: ____.`,
  'Perio Re-Eval': `Subjective: Follow-up for periodontal therapy. 
Objective: Probing depths rechecked. Tissue condition reviewed. 
Assessment: ____. 
Plan: ____.`
};

export default function PatientNoteComposer({ patientId, voiceDraft, aiDraft }) {
  const [selectedTemplate, setSelectedTemplate] = useState('');
  const [noteDraft, setNoteDraft] = useState('');
  const [finalized, setFinalized] = useState(false);

  useEffect(() => {
    if (selectedTemplate && !noteDraft) {
      setNoteDraft(templates[selectedTemplate]);
    }
  }, [selectedTemplate]);

  useEffect(() => {
    if (aiDraft || voiceDraft) {
      setNoteDraft((prev) => `${prev}\n\nAI/Voice Draft:\n${aiDraft || ''}${voiceDraft || ''}`);
    }
  }, [aiDraft, voiceDraft]);

  const handleApprove = () => {
    // TODO: Send to backend, lock note to provider, timestamp it
    setFinalized(true);
  };

  const handleEdit = () => {
    setFinalized(false);
  };

  return (
    <Card className="w-full p-4 mt-4">
      <CardContent>
        <div className="mb-2">
          <label>Select Template: </label>
          <select
            className="border rounded p-2"
            value={selectedTemplate}
            onChange={(e) => setSelectedTemplate(e.target.value)}
            disabled={finalized}
          >
            <option value="">-- Choose a template --</option>
            {Object.keys(templates).map((key) => (
              <option key={key} value={key}>{key}</option>
            ))}
          </select>
        </div>

        <Textarea
          className="w-full h-64 border rounded p-2"
          value={noteDraft}
          onChange={(e) => setNoteDraft(e.target.value)}
          disabled={finalized}
        />

        <div className="mt-4 flex gap-2">
          {!finalized && <Button onClick={handleApprove}>Approve Note</Button>}
          {finalized && <Button onClick={handleEdit}>Edit</Button>}
        </div>
      </CardContent>
    </Card>
  );
}
